---
- name: Setup EC2 with Nginx, Node.js, npm, and Swap
  hosts: ec2
  become: yes
  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Install prerequisites for Node.js
      apt:
        name: [curl, software-properties-common]
        state: present

    - name: Add NodeSource repository for Node.js 18
      shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      args:
        executable: /bin/bash

    - name: Install Node.js (includes npm)
      apt:
        name: nodejs
        state: present

    - name: Check if swap already exists
      command: swapon --show
      register: swap_status
      changed_when: false

    - name: Create swap file
      command: fallocate -l 4G /swapfile
      when: swap_status.stdout == ""
      args:
        creates: /swapfile

    - name: Set swapfile permissions
      file:
        path: /swapfile
        mode: '0600'
      when: swap_status.stdout == ""

    - name: Format swapfile
      command: mkswap /swapfile
      when: swap_status.stdout == ""

    - name: Enable swapfile
      command: swapon /swapfile
      when: swap_status.stdout == ""

    - name: Add swap entry to /etc/fstab
      mount:
        name: none
        src: /swapfile
        fstype: swap
        opts: sw
        state: present
      when: swap_status.stdout == ""
